<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>关于不可变对象--字符串的补充随笔 | 哪吒的莲花座</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">关于不可变对象--字符串的补充随笔</h1><a id="logo" href="/.">哪吒的莲花座</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">关于不可变对象--字符串的补充随笔</h1><div class="post-meta">2021-03-09</div><div class="post-content"><p>上一篇写了不可变对象与可变对象的比较以及他们在内存中的存储关系，但是最近在刷题的过程中遇到的一道题让我突然很好奇直接赋值的字符串与拼接得到的字符串在相同时在内存中是否会被当成同一个对象…</p>
<a id="more"></a>

<p>于是我通过查看不同字符串的id来验证我的想法，结果发现这真不像我在之前提到的那样简单。</p>
<p>先看代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;abcdef&#x27;</span></span><br><span class="line">b = <span class="string">&#x27;abcdef&#x27;</span></span><br><span class="line">c = <span class="string">&#x27;abacdef&#x27;</span></span><br><span class="line">d = c[<span class="number">0</span>:<span class="number">2</span>] + c[<span class="number">3</span>:]</span><br><span class="line">e = d</span><br><span class="line">g = <span class="string">&#x27;&#x27;</span>.join([c[<span class="number">0</span>:<span class="number">2</span>], c[<span class="number">3</span>:]])</span><br><span class="line">print(a, id(a), <span class="string">&#x27;\n&#x27;</span>, b, id(b), <span class="string">&#x27;\n&#x27;</span>, c, id(c), <span class="string">&#x27;\n&#x27;</span>, d, id(d), <span class="string">&#x27;\n&#x27;</span>, e, id(f), <span class="string">&#x27;\n&#x27;</span>, g, id(g))</span><br></pre></td></tr></table></figure>

<p>在我的预想中，因为字符串是不可变对象，所以当字符串的<strong>值</strong>相同时理应是同一个对象，也就是id应该相同。但实际上，不管是通过<code>&#39;+&#39;</code>号拼接而成的字符串d，还是用<code>.join()</code>连接成的字符串g，它们的id都与字符串a,b不同，且各不相同。但是将d的值赋值给e后，e的id却又与字符串a,b相同了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>abcdef <span class="number">1612581209568</span>            <span class="comment"># a，相同</span></span><br><span class="line">    abcdef <span class="number">1612581209568</span>            <span class="comment"># b，相同</span></span><br><span class="line">    abacdef <span class="number">1612581343280</span> </span><br><span class="line">    abcdef <span class="number">1612581957112</span>    <span class="comment"># d,不同</span></span><br><span class="line">    abcdef <span class="number">1612581209568</span>            <span class="comment"># e，相同</span></span><br><span class="line">    abcdef <span class="number">1612581956944</span>    <span class="comment"># g,不同</span></span><br></pre></td></tr></table></figure>

<p>这就与我之前用来验证字符串是不可变对象所以相同的字符串存储地址一样的简单设想相悖了。虽然可以看到，直接赋值且完全相同的字符串a和b的id，以及用d的值赋值的e的id的确是一样的。</p>
<p>这到底是为什么呢？</p>
<p>经过搜索，我了解到了这么一个python的机制：<strong>字符串驻留</strong></p>
<h2 id="字符串驻留"><a href="#字符串驻留" class="headerlink" title="字符串驻留"></a>字符串驻留</h2><p>原来，字符串，数字等对象在相同的情况下存储在同一内存地址，有着同一id的原因不只是因为他们是不可变对象，还因为Python的字符串驻留机制。</p>
<p>当我们为一个变量a赋值为字符串‘abcdef’的时候，此时a指向值‘abcdef’的内存地址，那么当我们再次为变量b赋同一个值的时候，Python解释器会先在驻留内存中查找是否已经存在这个‘abcdef’对象，如果已经存在就不再创造新的对象，两个变量a和b共享同一个对象。</p>
<p>而这个机制有它自己的一些条件。</p>
<h4 id="1-仅包含字母、数字、下划线的字符串，python会启用驻留机制"><a href="#1-仅包含字母、数字、下划线的字符串，python会启用驻留机制" class="headerlink" title="1. 仅包含字母、数字、下划线的字符串，python会启用驻留机制"></a>1. 仅包含字母、数字、下划线的字符串，python会启用驻留机制</h4><p>因为Python解释器仅对看起来像python标识符的字符串使用intern()方法，而python标识符正是由字母、数字和下划线组成。当赋值的字符串包含了其他特殊符号的时候，驻留机制就不会启动，即使看起来相同的字符串id也会不同，分别被存储为两个对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;asdf!&#x27;</span></span><br><span class="line">b = <span class="string">&#x27;asdf!&#x27;</span></span><br><span class="line">print(id(a))</span><br><span class="line">print(id(b))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 1612581954200</span><br><span class="line">    1612581953976</span><br></pre></td></tr></table></figure>

<h4 id="2-python会针对整数范围是-5-256-的整数启用驻留机制"><a href="#2-python会针对整数范围是-5-256-的整数启用驻留机制" class="headerlink" title="2. python会针对整数范围是[-5, 256]的整数启用驻留机制"></a>2. python会针对整数范围是[-5, 256]的整数启用驻留机制</h4><p>只有[-5, 256]范围内的整数赋值时id相同，超过这个范围的整数存储时也会被存储为不同对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">12345</span></span><br><span class="line">b = <span class="number">12345</span></span><br><span class="line">c = <span class="number">123</span></span><br><span class="line">d = <span class="number">123</span></span><br><span class="line">print(id(a))</span><br><span class="line">print(id(b))</span><br><span class="line">print(id(c))</span><br><span class="line">print(id(d))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 1612581143632</span><br><span class="line">    1612581143888</span><br><span class="line">    1433205680</span><br><span class="line">    1433205680</span><br></pre></td></tr></table></figure>

<h2 id="回到开头问题——"><a href="#回到开头问题——" class="headerlink" title="回到开头问题——"></a>回到开头问题——</h2><p>知道了这个字符串驻留的机制后，明白了为什么相同的字符串可能会被存储为相同对象。</p>
<p>但是这其实并没有完全解决为什么经过拼接的字符串明明是相同的，而且也符合驻留机制的第一点——只由字母构成，但是却被存储为不同对象的问题。</p>
<p>于是使用<code>dis.dis()</code>对赋值过程进行字节码反汇编看看这其中的过程出了什么问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">combine</span>():</span></span><br><span class="line">    a = <span class="string">&#x27;abcdef&#x27;</span></span><br><span class="line">    b = <span class="string">&#x27;abcdef&#x27;</span></span><br><span class="line">    c = <span class="string">&#x27;abacdef&#x27;</span></span><br><span class="line">    d = c[<span class="number">0</span>:<span class="number">2</span>] + c[<span class="number">3</span>:]</span><br><span class="line">    e = d</span><br><span class="line">    </span><br><span class="line">dis.dis(combine)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>           <span class="number">0</span> LOAD_CONST               <span class="number">1</span> (<span class="string">&#x27;abcdef&#x27;</span>)    <span class="comment">#获取常量‘abcdef’</span></span><br><span class="line">            <span class="number">2</span> STORE_FAST               <span class="number">0</span> (a)           <span class="comment">#将常量‘abcdef’存入a</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span>           <span class="number">4</span> LOAD_CONST               <span class="number">1</span> (<span class="string">&#x27;abcdef&#x27;</span>)    <span class="comment">#获取常量‘abcdef’</span></span><br><span class="line">            <span class="number">6</span> STORE_FAST               <span class="number">1</span> (b)           <span class="comment">#将常量‘abcdef’存入b</span></span><br><span class="line"></span><br><span class="line"><span class="number">6</span>           <span class="number">8</span> LOAD_CONST               <span class="number">2</span> (<span class="string">&#x27;abacdef&#x27;</span>)</span><br><span class="line">           <span class="number">10</span> STORE_FAST               <span class="number">2</span> (c)</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>          <span class="number">12</span> LOAD_FAST                <span class="number">2</span> (c)</span><br><span class="line">           <span class="number">14</span> LOAD_CONST               <span class="number">3</span> (<span class="number">0</span>)</span><br><span class="line">           <span class="number">16</span> LOAD_CONST               <span class="number">4</span> (<span class="number">2</span>)</span><br><span class="line">           <span class="number">18</span> BUILD_SLICE              <span class="number">2</span></span><br><span class="line">           <span class="number">20</span> BINARY_SUBSCR</span><br><span class="line">           <span class="number">22</span> LOAD_FAST                <span class="number">2</span> (c)</span><br><span class="line">           <span class="number">24</span> LOAD_CONST               <span class="number">5</span> (<span class="number">3</span>)</span><br><span class="line">           <span class="number">26</span> LOAD_CONST               <span class="number">0</span> (<span class="literal">None</span>)</span><br><span class="line">           <span class="number">28</span> BUILD_SLICE              <span class="number">2</span></span><br><span class="line">           <span class="number">30</span> BINARY_SUBSCR</span><br><span class="line">           <span class="number">32</span> BINARY_ADD</span><br><span class="line">           <span class="number">34</span> STORE_FAST               <span class="number">3</span> (d)           <span class="comment">#将BINARY_ADD的结果存入d</span></span><br><span class="line"></span><br><span class="line"><span class="number">8</span>          <span class="number">36</span> LOAD_FAST                <span class="number">3</span> (d)           <span class="comment">#获取d的值‘abcdef’</span></span><br><span class="line">           <span class="number">38</span> STORE_FAST               <span class="number">4</span> (e)           <span class="comment">#将d的值‘abcdef’存入e</span></span><br><span class="line">           <span class="number">40</span> LOAD_CONST               <span class="number">0</span> (<span class="literal">None</span>)</span><br><span class="line">           <span class="number">42</span> RETURN_VALUE</span><br></pre></td></tr></table></figure>

<p>从字节码可以看出，</p>
<ul>
<li>对a,b,e的赋值过程都是LOAD -&gt; STORE的过程</li>
<li>而对d的赋值过程是将切片后所得的两个字符串进行BINARY_ADD后直接进行存储</li>
</ul>
<p>虽然a,b是获取了字符串常量‘abcdef’后进行存储，而e是从d中读取了字符串值‘abcdef’后进行存储，但是他们本质都是将相同的字符串值‘abcdef’存入对象。</p>
<p>我们可以由此推测，python的驻留机制是在LOAD -&gt; STORE的过程中发生的，所以在这个过程中python会在驻留内存中查找是否有相同的字符串并存入。而因为对d的过程是直接将计算结果赋值给d，所以驻留机制就没有启动。</p>
<p>对于使用<code>.join()</code>连接的字符串也是同样的道理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="string">&#x27;&#x27;</span>.join([c[<span class="number">0</span>:<span class="number">2</span>], c[<span class="number">3</span>:]])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span>             <span class="number">4</span> LOAD_CONST               <span class="number">2</span> (<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">              <span class="number">6</span> LOAD_ATTR                <span class="number">0</span> (join)</span><br><span class="line">              <span class="number">8</span> LOAD_FAST                <span class="number">0</span> (c)</span><br><span class="line">             <span class="number">10</span> LOAD_CONST               <span class="number">3</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">12</span> LOAD_CONST               <span class="number">4</span> (<span class="number">2</span>)</span><br><span class="line">             <span class="number">14</span> BUILD_SLICE              <span class="number">2</span></span><br><span class="line">             <span class="number">16</span> BINARY_SUBSCR</span><br><span class="line">             <span class="number">18</span> LOAD_FAST                <span class="number">0</span> (c)</span><br><span class="line">             <span class="number">20</span> LOAD_CONST               <span class="number">5</span> (<span class="number">3</span>)</span><br><span class="line">             <span class="number">22</span> LOAD_CONST               <span class="number">0</span> (<span class="literal">None</span>)</span><br><span class="line">             <span class="number">24</span> BUILD_SLICE              <span class="number">2</span></span><br><span class="line">             <span class="number">26</span> BINARY_SUBSCR</span><br><span class="line">             <span class="number">28</span> BUILD_LIST               <span class="number">2</span></span><br><span class="line">             <span class="number">30</span> CALL_FUNCTION            <span class="number">1</span>        <span class="comment">#从函数join()获取返回值</span></span><br><span class="line">             <span class="number">32</span> STORE_FAST               <span class="number">1</span> (f)    <span class="comment">#直接将返回值存入f</span></span><br></pre></td></tr></table></figure></div><div class="tags"></div><div class="post-nav"><a class="next" href="/2021/01/10/Python%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E3%80%81%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%9C%A8%E5%87%BD%E6%95%B0%E5%86%85%E5%A4%96%E9%83%A8%E7%9A%84%E5%85%B3%E7%B3%BB/">Python全局变量、局部变量在函数内外部的关系</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/python/" style="font-size: 15px;">python</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/03/09/%E5%85%B3%E4%BA%8E%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E8%A1%A5%E5%85%85%E9%9A%8F%E7%AC%94/">关于不可变对象--字符串的补充随笔</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/10/Python%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E3%80%81%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%9C%A8%E5%87%BD%E6%95%B0%E5%86%85%E5%A4%96%E9%83%A8%E7%9A%84%E5%85%B3%E7%B3%BB/">Python全局变量、局部变量在函数内外部的关系</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/12/CPython%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E3%80%81GIL%E4%B8%8E%E9%94%81/">CPython中的多线程、GIL与锁</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/30/python%E5%AE%9E%E7%8E%B0%E5%AF%B9%E7%BD%91%E7%BB%9C%E5%9B%BE%E7%9A%84LS%E7%AE%97%E6%B3%95/">python实现对网络图的LS算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/26/Linux-%E6%80%BB%E7%BB%93-1/">Linux 总结(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/26/MySQL-%E8%AF%AD%E5%8F%A5%E6%80%BB%E7%BB%93-1/">MySQL 语句总结(1)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">哪吒的莲花座.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>